<!-- templates/inbox.html -->
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Priva-708 â€” BoÃ®te</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        background: linear-gradient(135deg,#0f1720,#081226);
        color: #e6eef6;
        font-family: "Segoe UI", Roboto, sans-serif;
        min-height: 100vh;
      }
      .glass {
        backdrop-filter: blur(8px) saturate(120%);
        -webkit-backdrop-filter: blur(8px) saturate(120%);
        background-color: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        padding: 20px;
      }
      .accent { color: #8ad0ff; }
      .card-glass { background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius: 12px; padding: 16px; }
      small { color: #cbd5e1; }
      /* small video sizing for modal */
      video { border-radius: 8px; background: #000; max-height: 60vh; }
      .opacity-50 { opacity: 0.5; }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-11 col-md-10">
          <div class="glass">
            <div class="d-flex align-items-center mb-3">
              <h3 class="me-auto accent">Priva-708</h3>
              <div class="text-end">
                <div>{{ user.first }} {{ user.last }}</div>
                <button class="btn btn-sm btn-outline-light mt-1" id="logoutBtn">DÃ©connexion</button>
              </div>
            </div>

            <div class="d-flex mb-3">
              <button class="btn btn-success me-2" id="composeBtn">Nouveau message</button>
              <div class="ms-auto">
                <span class="text-muted small">ConnectÃ© en tant que</span>
                <strong class="ms-1">{{ user.first }}</strong>
              </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" id="boxTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#inbox" type="button" role="tab">ðŸ“¥ RÃ©ception</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab">ðŸ“¤ EnvoyÃ©s</button>
              </li>
            </ul>

            <div class="tab-content">
              <!-- INBOX -->
              <div class="tab-pane fade show active" id="inbox" role="tabpanel">
                {% if inbox %}
                  <div class="list-group">
                    {% for m in inbox %}
                      <div class="list-group-item d-flex align-items-center">
                        <div>
                          <div><strong>ID {{ m.id }}</strong> â€” de <em>{{ m.from }}</em></div>
                          <small>{{ (m.timestamp|int)|datetimeformat }}</small>
                        </div>
                        <div class="ms-auto d-flex align-items-center">
                          {% if m.requires_code %}
                            <span class="badge bg-warning text-dark me-2">ProtÃ©gÃ©</span>
                          {% endif %}
                          <button class="btn btn-sm btn-primary me-2 read-btn" data-box="inbox" data-id="{{ m.id }}">Lire</button>
                          <button class="btn btn-sm btn-outline-danger del-btn me-2" data-box="inbox" data-id="{{ m.id }}">Supprimer</button>
                          <!-- Call button: calls the sender -->
                          <button class="btn btn-sm btn-outline-success call-btn" data-email="{{ m.from }}" title="Appeler {{ m.from }}">ðŸ“ž</button>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="card-glass">Aucun message pour l'instant.</div>
                {% endif %}
              </div>

              <!-- SENT -->
              <div class="tab-pane fade" id="sent" role="tabpanel">
                {% if sent %}
                  <div class="list-group">
                    {% for m in sent %}
                      <div class="list-group-item d-flex align-items-center">
                        <div>
                          <div><strong>ID {{ m.id }}</strong> â€” vers <em>{{ m.to }}</em></div>
                          <small>{{ (m.timestamp|int)|datetimeformat }}</small>
                        </div>
                        <div class="ms-auto d-flex align-items-center">
                          <button class="btn btn-sm btn-outline-primary me-2 read-btn" data-box="sent" data-id="{{ m.id }}">Voir</button>
                          <button class="btn btn-sm btn-outline-danger del-btn me-2" data-box="sent" data-id="{{ m.id }}">Supprimer</button>
                          <!-- Call button: calls the recipient -->
                          <button class="btn btn-sm btn-outline-success call-btn" data-email="{{ m.to }}" title="Appeler {{ m.to }}">ðŸ“ž</button>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="card-glass">Vous n'avez encore rien envoyÃ©.</div>
                {% endif %}
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Read message -->
    <div class="modal fade" id="readModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title">Message</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="read-meta" class="mb-2 small text-muted"></div>
            <div id="read-error" class="mb-2 text-danger"></div>

            <div id="requires-code-row" class="mb-2" style="display:none;">
              <label class="form-label">Code du message</label>
              <input class="form-control" id="msg_code" placeholder="Entrez le code de protection (si requis)">
            </div>

            <div id="account-code-row" class="mb-2">
              <label class="form-label">Ton code de compte (pour dÃ©verrouiller ta clÃ© privÃ©e)</label>
              <input class="form-control" id="account_code" placeholder="Ton code (mÃªme que celui de connexion)">
            </div>

            <pre id="read-plaintext" class="p-3 bg-light text-dark" style="white-space:pre-wrap; display:none;"></pre>
          </div>
          <div class="modal-footer">
            <button type="button" id="readDecryptBtn" class="btn btn-primary">DÃ©chiffrer / Afficher</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            <button type="button" id="deleteMsgBtn" class="btn btn-danger">Supprimer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Compose -->
    <div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title">Nouveau message</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="compose-error" class="mb-2 text-danger"></div>
            <div class="mb-2">
              <label class="form-label">Destinataire (email)</label>
              <input id="compose-recipient" class="form-control" list="emailList" placeholder="ex: alice@example.com" autocomplete="off">
              <datalist id="emailList"></datalist>
            </div>
            <div class="mb-2">
              <label class="form-label">Contenu</label>
              <textarea id="compose-content" class="form-control" rows="6"></textarea>
            </div>
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="compose-protected">
              <label class="form-check-label" for="compose-protected">ProtÃ©ger par code</label>
            </div>
            <div id="compose-code-row" style="display:none;">
              <label class="form-label">Code de protection (pour le destinataire)</label>
              <input id="compose-code" class="form-control" placeholder="Code que le destinataire devra saisir pour lire">
            </div>
          </div>
          <div class="modal-footer">
            <button id="sendMsgBtn" class="btn btn-success">Envoyer</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Call (audio + video) -->
    <div class="modal fade" id="callModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="callWith">Appel</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" id="closeCallModal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-6 d-flex justify-content-center align-items-center">
                <div class="w-100 text-center">
                  <div class="mb-2 small text-muted">Ta vidÃ©o</div>
                  <video id="localVideo" autoplay muted playsinline style="width:100%; max-height:60vh;"></video>
                </div>
              </div>
              <div class="col-md-6 d-flex justify-content-center align-items-center">
                <div class="w-100 text-center">
                  <div class="mb-2 small text-muted">VidÃ©o distante</div>
                  <video id="remoteVideo" autoplay playsinline style="width:100%; max-height:60vh;"></video>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="toggleCamBtn" class="btn btn-outline-light">DÃ©sactiver camÃ©ra</button>
            <button id="toggleMicBtn" class="btn btn-outline-light">Couper micro</button>
            <button id="hangupBtn" class="btn btn-danger">Raccrocher</button>
          </div>
        </div>
      </div>
    </div>

    <!-- scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- socket.io client (cdn) -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
      // small debug helpers
      window.addEventListener('error', (e) => console.error('Global JS error:', e.message, e.filename, e.lineno, e.colno));
      window.addEventListener('unhandledrejection', (e) => console.error('Unhandled promise rejection:', e.reason));
      console.log('inbox.js loaded', new Date().toISOString());

      // Helpers
      function showError(el, text){ el.textContent = text; el.style.display = text ? 'block' : 'none'; }

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await fetch('/api/logout', {method:'POST'});
        window.location = '/login';
      });

      // Compose modal
      const composeModal = new bootstrap.Modal(document.getElementById('composeModal'));
      document.getElementById('composeBtn').addEventListener('click', () => {
        document.getElementById('compose-recipient').value = '';
        document.getElementById('compose-content').value = '';
        document.getElementById('compose-protected').checked = false;
        document.getElementById('compose-code-row').style.display = 'none';
        showError(document.getElementById('compose-error'), '');
        composeModal.show();
      });
      document.getElementById('compose-protected').addEventListener('change', (e) => {
        document.getElementById('compose-code-row').style.display = e.target.checked ? 'block' : 'none';
      });

      document.getElementById('sendMsgBtn').addEventListener('click', async () => {
        const recipient = document.getElementById('compose-recipient').value.trim();
        const content = document.getElementById('compose-content').value.trim();
        const protectedFlag = document.getElementById('compose-protected').checked;
        const code = document.getElementById('compose-code').value;
        const body = { recipient, content, requires_code: protectedFlag };
        if (protectedFlag) body.code = code;
        const res = await fetch('/api/message/send', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const j = await res.json();
        if (res.ok) {
          composeModal.hide();
          location.reload();
        } else {
          showError(document.getElementById('compose-error'), j.error || 'Erreur');
        }
      });

      // Read modal
      const readModal = new bootstrap.Modal(document.getElementById('readModal'));
      let currentRead = { box: null, id: null, requires_code: false };

      // delete from modal
      document.getElementById('deleteMsgBtn').addEventListener('click', async () => {
        if (!confirm('Voulez-vous vraiment supprimer ce message ?')) return;
        try {
          const res = await fetch('/api/message/delete', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ box: currentRead.box, msg_id: currentRead.id })
          });
          const j = await res.json();
          if (res.ok && j.ok) {
            readModal.hide();
            // remove from DOM if exists, else reload
            document.querySelectorAll(`[data-id="${currentRead.id}"]`).forEach(el=>{
              const li = el.closest('.list-group-item');
              if (li) li.remove();
            });
            // fallback reload
            // location.reload();
          } else {
            showError(document.getElementById('read-error'), j.error || 'Erreur suppression');
          }
        } catch (err) {
          showError(document.getElementById('read-error'), 'Erreur rÃ©seau');
        }
      });

      // Delegated click handler: read / delete (list) / call
      document.addEventListener('click', async function (ev) {
        // DELETE button in list
        const delBtn = ev.target.closest && ev.target.closest('.del-btn');
        if (delBtn) {
          ev.preventDefault();
          const box = delBtn.dataset.box;
          const id = delBtn.dataset.id;
          if (!box || !id) { alert('Identifiant manquant'); return; }
          if (!confirm('Supprimer ce message ?')) return;
          try {
            delBtn.disabled = true;
            delBtn.classList.add('opacity-50');
            const res = await fetch('/api/message/delete', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ box: box, msg_id: id })
            });
            const j = await res.json();
            if (res.ok && j.ok) {
              const li = delBtn.closest('.list-group-item');
              if (li) li.remove(); else location.reload();
            } else {
              alert(j.error || 'Erreur suppression');
              delBtn.disabled = false;
              delBtn.classList.remove('opacity-50');
            }
          } catch (err) {
            console.error('delete fetch error', err);
            alert('Erreur rÃ©seau');
            delBtn.disabled = false;
            delBtn.classList.remove('opacity-50');
          }
          return;
        }

        // READ / VIEW button
        const readBtn = ev.target.closest && ev.target.closest('.read-btn');
        if (readBtn) {
          ev.preventDefault();
          currentRead.box = readBtn.dataset.box;
          currentRead.id = readBtn.dataset.id;
          document.getElementById('read-plaintext').style.display = 'none';
          document.getElementById('read-plaintext').textContent = '';
          document.getElementById('msg_code').value = '';
          document.getElementById('account_code').value = '';
          showError(document.getElementById('read-error'), '');
          document.getElementById('requires-code-row').style.display = 'none';
          document.getElementById('read-meta').textContent = (currentRead.box === 'inbox' ? 'Lecture (rÃ©ception) â€” ID ' : 'Message envoyÃ© â€” ID ') + currentRead.id;
          readModal.show();
          // If sent: hide account code
          if (currentRead.box === 'sent') {
            document.getElementById('account-code-row').style.display = 'none';
          } else {
            document.getElementById('account-code-row').style.display = 'block';
          }
          return;
        }

        // CALL button
        const callBtn = ev.target.closest && ev.target.closest('.call-btn');
        if (callBtn) {
          ev.preventDefault();
          const email = callBtn.dataset.email;
          if (!email) { alert('Adresse inconnue'); return; }
          try {
            await startCall(email);
          } catch (err) {
            console.error('Erreur startCall', err);
            alert('Impossible de lancer l\'appel : ' + (err.message || err));
          }
          return;
        }
      });

      // Decrypt / Read content from modal
      document.getElementById('readDecryptBtn').addEventListener('click', async () => {
        showError(document.getElementById('read-error'), '');
        const btn = document.getElementById('readDecryptBtn');
        btn.disabled = true;
        try {
          const payload = { box: currentRead.box, msg_id: currentRead.id };
          const code = document.getElementById('msg_code').value;
          const account_code = document.getElementById('account_code').value;
          if (code) payload.code = code;
          if (account_code) payload.account_code = account_code;
          const res = await fetch('/api/message/read', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const j = await res.json();
          if (res.ok && j.ok) {
            document.getElementById('read-plaintext').style.display = 'block';
            document.getElementById('read-plaintext').textContent = j.plaintext;
            document.getElementById('requires-code-row').style.display = 'none';
            document.getElementById('account-code-row').style.display = 'none';
          } else {
            if (res.status === 401) {
              showError(document.getElementById('read-error'), j.error || 'AccÃ¨s refusÃ©');
              document.getElementById('requires-code-row').style.display = 'block';
            } else {
              showError(document.getElementById('read-error'), j.error || 'Erreur lecture');
            }
          }
        } catch (err) {
          showError(document.getElementById('read-error'), 'Erreur rÃ©seau');
        } finally {
          btn.disabled = false;
        }
      });

      // Small UX: when compose modal hidden, clear fields
      document.getElementById('composeModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('compose-recipient').value = '';
        document.getElementById('compose-content').value = '';
        document.getElementById('compose-code').value = '';
      });

      // === Autocomplete emails ===
      const emailInput = document.getElementById('compose-recipient');
      const emailList = document.getElementById('emailList');

      emailInput.addEventListener('focus', async () => {
        if (emailList.children.length > 0) return;
        try {
          const res = await fetch('/api/users');
          const j = await res.json();
          if (res.ok && j.emails) {
            emailList.innerHTML = '';
            j.emails.forEach(e => {
              const opt = document.createElement('option');
              opt.value = e;
              emailList.appendChild(opt);
            });
          }
        } catch (err) {
          console.warn('Erreur chargement liste emails', err);
        }
      });

      /*******************************
       *  WebRTC + Socket.IO section *
       *******************************/

      // STUN configuration
      const RTC_CONFIG = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

      // init socket.io (will send cookie automatically)
      const socket = io({ transports: ['websocket'] });

      // peer connection and streams
      let pc = null;
      let localStream = null;
      let remoteStream = null;
      let currentTarget = null; // email of the peer we are calling / receiving from
      const callModal = new bootstrap.Modal(document.getElementById('callModal'));
      const localVid = document.getElementById('localVideo');
      const remoteVid = document.getElementById('remoteVideo');
      const callWithTitle = document.getElementById('callWith');
      const toggleCamBtn = document.getElementById('toggleCamBtn');
      const toggleMicBtn = document.getElementById('toggleMicBtn');

      // start local media
      async function startLocalMedia() {
        if (localStream) return localStream;
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
          localVid.srcObject = localStream;
          return localStream;
        } catch (err) {
          alert('Impossible d\'accÃ©der Ã  la camÃ©ra/micro : ' + err.message);
          throw err;
        }
      }

      function createPeerConnection(targetEmail) {
        pc = new RTCPeerConnection(RTC_CONFIG);
        remoteStream = new MediaStream();
        remoteVid.srcObject = remoteStream;

        if (localStream) {
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }

        pc.ontrack = (evt) => {
          evt.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
        };

        pc.onicecandidate = (ev) => {
          if (ev.candidate) {
            socket.emit('webrtc_ice', { to: targetEmail, candidate: ev.candidate });
          }
        };

        pc.onconnectionstatechange = () => {
          if (!pc) return;
          if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed' || pc.connectionState === 'closed') {
            stopCall();
          }
        };

        return pc;
      }

      async function startCall(targetEmail) {
        currentTarget = targetEmail;
        callWithTitle.textContent = 'Appel vers ' + targetEmail;
        await startLocalMedia();
        createPeerConnection(targetEmail);

        // ensure local tracks are present
        if (localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.emit('webrtc_offer', { to: targetEmail, sdp: pc.localDescription });
        callModal.show();
      }

      socket.on('webrtc_offer', async (data) => {
        const sender = data.from || data.sender || 'inconnu';
        const accept = confirm(`Appel entrant de ${sender} â€” accepter ?`);
        if (!accept) return;
        currentTarget = sender;
        callWithTitle.textContent = 'Appel de ' + sender;
        await startLocalMedia();
        createPeerConnection(sender);

        try {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.emit('webrtc_answer', { to: sender, sdp: pc.localDescription });
          callModal.show();
        } catch (err) {
          console.error('Erreur handling offer', err);
        }
      });

      socket.on('webrtc_answer', async (data) => {
        if (!pc) return;
        try {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        } catch (err) {
          console.warn('setRemoteDescription failed', err);
        }
      });

      socket.on('webrtc_ice', async (data) => {
        if (!data || !data.candidate || !pc) return;
        try {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (err) {
          console.warn('addIceCandidate failed', err);
        }
      });

      socket.on('incoming_call', (data) => {
        console.log('incoming call', data);
      });

      function stopCall() {
        try {
          if (pc) {
            pc.getSenders().forEach(s => { try { s.track && s.track.stop(); } catch(e){} });
            pc.close();
            pc = null;
          }
        } catch(e) { console.warn(e); }
        try {
          if (localStream) {
            localStream.getTracks().forEach(t => { try { t.stop(); } catch(e){} });
            localStream = null;
          }
        } catch(e){}
        try {
          if (remoteStream) {
            remoteStream.getTracks().forEach(t => { try { t.stop(); } catch(e){} });
            remoteStream = null;
          }
        } catch(e){}
        localVid.srcObject = null;
        remoteVid.srcObject = null;
        currentTarget = null;
        callModal.hide();
      }

      document.getElementById('hangupBtn').addEventListener('click', () => stopCall());
      toggleCamBtn.addEventListener('click', () => {
        if (!localStream) return;
        const videoTrack = localStream.getVideoTracks()[0];
        if (!videoTrack) return;
        videoTrack.enabled = !videoTrack.enabled;
        toggleCamBtn.textContent = videoTrack.enabled ? 'DÃ©sactiver camÃ©ra' : 'Activer camÃ©ra';
      });
      toggleMicBtn.addEventListener('click', () => {
        if (!localStream) return;
        const audioTrack = localStream.getAudioTracks()[0];
        if (!audioTrack) return;
        audioTrack.enabled = !audioTrack.enabled;
        toggleMicBtn.textContent = audioTrack.enabled ? 'Couper micro' : 'Activer micro';
      });

      document.getElementById('closeCallModal').addEventListener('click', () => stopCall());
      window.addEventListener('beforeunload', () => { try { socket.disconnect(); } catch(e){} stopCall(); });
    </script>
  </body>
</html>
